<head>
    <title>News Feed</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<!------ Include the above in your HEAD tag ---------->
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
        crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous"/>
	<link rel="stylesheet" type="text/css" href="pennbook.css"/>
</head>

<body>
	<!--Top Header bar: Title of page, Toolbar, Search bar-->
	<nav class="navbar">
		<!--Title-->
	<a href="/home" class="navbar-brand" style="font-size:36px; color:#99DFFF">PennBook</a>
	<!--Toolbar-->
	<div class="toolbar-container">
        <a class="button" href="/home" role="button">
            &#127969;
            Home
        </a>
        <a class="button" href="/wall?wallToVisit=<%=username%>" role="button">
            &#128204;
            My Wall
        </a>
        <a class="button" href="/settings" role="button">
            &#128295;
            Settings
        </a>
        <a class="button" href="/news" role="button">
            &#128240;
            News
        </a>
        <a class="button" href="/logout" role="button">
            &#128682;
			Log Out
		</a>
    </div>
		<!-- News Search Bar-->
		<form action="/searchnews" method="post" class="form-inline">
			<div class="input-group">
				<label for="keyword"><font color="white">Search for an article:&nbsp</font></label>
				<input type="text" name="keyword" required class="form-control" aria-describedby="button-addon2">
				<div class="input-group-append">
					<button class="btn btn-outline-primary" type="submit" id="button-addon2">
						<i class="fa fa-search"></i>
					</button>
				</div>
			</div>
		</form>
	</nav>
	
	<font color="white"><font size="20"><center>Recommended News</center></font></font>
	
	<% if (articles.length == 0) { %>
		<font color="red"><font size="15">Like more articles to get news recommendations.</font></font>
	<% } %>
	
	<!--- All articles in a div -->
    <div id="allArticles">
    
	</div>
  
</body>

<script>
	var articleNamesOnClient = [];
	
	// function that unescapes all special characters in a string
	function htmlDecode(input){
		var e = document.createElement('div');
		e.innerHTML = input;
		return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
	}
	
	function initNewsPage() {
		// container for all of the articles
		var container = document.getElementById("allArticles");
	
		// iterate through all of the articles
		<% articles.forEach(article => { %>
			// initially display every article on the user's news feed
		    var content = "<div class=\"blog-card\"><div class=\"meta\"><div class=\"photo\" style=\"background-image: ";
		    content += "url(https://www.nyacknewsandviews.com/wp-content/uploads/2016/03/trump-600x450.jpg)\"></div>";
			content += "<ul class=\"details\"><li class=\"author\">";
        	<% if (article.authors) { %>
				content += "<%=article.authors%>";
			<% } else { %>
				content += "No authors found.";
			<% } %>
        	content += "</li><li class=\"date\">";
        	content += "<%=article.date%>";
        	content += "</li><li class=\"tags\"><ul><li>";
        	content += "<%=article.category%>";
        	content += "</li></ul></li></ul></div>";
        	content += "<div class=\"description\"><h1>";
        	content += htmlDecode("<%=article.article%>");
        	content += "</h1><p>";
        	content += "<%=article.description%>";
        	content += "</p><p class=\"read-more\"><a href=\"";
        	content += "<%=article.link%>";
        	content += "\">Read More</a></p></div></div>";
        	
        	// display the like button below each article
			content += "<form action=\"/likearticle\" method=\"post\" class=\"blog-card\">";
			content += "<input id=\"articleToLike\" name=\"articleToLike\" type=\"hidden\" align=\"center\" value=\"";
			content += htmlDecode("<%=article.article%>");
			content += "\"><button type=\"submit\" class=\"btn btn-primary btn-block\">Like</button></form>";
			
			// append the content to the container's inner HTML
			container.innerHTML += content;
	
			// add each article from the server into the list of articles stored on the client side
			articleNamesOnClient.push(htmlDecode("<%=article.article%>"));
		<% }); %>
	}
	
	initNewsPage();
	
	// automatic refresh every 1 hour to update the news page
	var refreshTime = function() {
		// set clock to refresh every 1 hour (1 hour = 3600000 ms)
		$("#clock").html((new Date()).toString());
		setTimeout(refreshTime, 3600000);
		// make AJAX call to get the news articles and compare the data from the server to the data on the client
		$.ajax({
				url: "/newsfeedupdate",
				type: "GET",
				success: function(data) {
					// list containing the differences between the server and client
					var newArticles = [];
					
					if (data.length == 0) {
						alert("No new articles to display.");
					}
						
					// iterate through data (articles) sent from server
					data.forEach(a => {
						// put the article in the list if it's from the server but not on the client
						if (!articleNamesOnClient.includes(htmlDecode(a.article))) {
							newArticles.push(a);
							// update the client-side list to contain new articles from the server
							articleNamesOnClient.push(htmlDecode(a.article));
						}
					});
					
					// get the container for all of the articles displayed
					var container = document.getElementById("allArticles");
						
					// iterate over all of the new articles
					newArticles.forEach(newArticle => {
						// display the new articles that the server has sent to the client
						var content = "<div class=\"blog-card\"><div class=\"meta\"><div class=\"photo\" style=\"background-image: ";
					    content += "url(https://www.nyacknewsandviews.com/wp-content/uploads/2016/03/trump-600x450.jpg)\"></div>";
						content += "<ul class=\"details\"><li class=\"author\">";
			        	if (newArticle.authors) {
							content += newArticle.authors;
						} else {
							content += "No authors found.";
						}
						content += "</li>";
			        	content += "<li class=\"date\">";
			        	content += newArticle.date;
			        	content += "</li>";
			        	content += "<li class=\"tags\"><ul><li>";
			        	content += newArticle.category;
			        	content += "</li></ul></li></ul></div>";
			        	content += "<div class=\"description\"><h1>";
			        	content += htmlDecode(newArticle.article);
			        	content += "</h1><p>";
			        	content += newArticle.description;
			        	content += "</p><p class=\"read-more\"><a href=\"";
			        	content += newArticle.link;
			        	content += "\">Read More</a></p></div></div>";
			        	
			        	// display the like button below each article
						content += "<form action=\"/likearticle\" method=\"post\" class=\"blog-card\">";
						content += "<input id=\"articleToLike\" name=\"articleToLike\" type=\"hidden\" align=\"center\" value=\"";
						content += htmlDecode(newArticle.article);
						content += "\"><button type=\"submit\" class=\"btn btn-primary btn-block\">Like</button></form>";
						
						// append the content to the beginning of the container's inner HTML
						container.innerHTML = (content + container.innerHTML);
					});
				},
				error: function(err) {
					// handle errors with AJAX calling database
					alert("Error with AJAX automatic refresh. Could not load new articles.");
					alert(err);
				}
			})
	};
	
	$(document).ready(function() {
		$("#clock").css("color", "white");
		setTimeout(refreshTime, 3600000);
	});
	
</script>
