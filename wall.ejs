<!--WALL EJS
    Variables used: 
    - user
    - isFriends to render different views
    Features
    - Make a Post like home page
    - Vertical field of posts made by USER
-->

<head>
    <title><%=user%></title>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<!------ Include the above in your HEAD tag ---------->
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
        crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous"/>
	<link rel="stylesheet" type="text/css" href="pennbook.css"/>
</head>
        
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<!--Top Header bar: Title of page, Toolbar, Search bar-->
<body>      
    <nav class="navbar">
	<!--Title-->
	<a href="/home" class="navbar-brand" style="font-size:36px; color:#99DFFF">PennBook</a>
	<!--Toolbar-->
	<div class="toolbar-container">
        <a class="button" href="/home" role="button">
            &#127969;
            Home
        </a>
        <a class="button" href="/wall?wallToVisit=<%=username%>" role="button">
            &#128204;
            My Wall
        </a>
        <a class="button" href="/settings" role="button">
            &#128295;
            Settings
        </a>
        <a class="button" href="/news" role="button">
            &#128240;
            News
        </a>
        <a class="button" href="/logout" role="button">
            &#128682;
			Log Out
		</a>
    </div>
	<!--Search Bar-->
	<div>
        <form class="form-inline" action="/searchforuser" method="post">
            <div class="input-group">
                <input type="text"  autocomplete="off" id="nameToSearch" name="nameToSearch" class="form-control" style="color:#E1E1E1;background-color:#3a3b3c;border-color:#242526">
                <div class="input-group-append">
                    <button class="btn btn-outline-primary" type="submit" id="button-addon2" style="color:#99DFFF">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </div>
        </form>
        <div class="search-list">
            <ul id="searchResult"></ul>
            <div class="clear"></div>
        </div>
    </div>
    </nav>


    <div class="container-fluid gedf-wrapper">
        <div class="row">
            <div class="col-md-3">
                <!--PHILIP REMOVE-->
                <div class="card" style="background-color:#242526;border-radius:10px">
                    <div class="card-body">
                        <a href="/wall?wallToVisit=<%=user%>" class="h5">@<%=user%></a><br>
                        <% if (isFriend) { %>
                            <br>
                            <form action="/deletefriend?wallToVisit=<%=user%>" method="post">
                                <button type="submit" class="btn btn-primary" style="background-color:#D10000; color:#E1E1E1; border-color:#830000">Remove Friend</button>
                            </form>
                        <% } else if (!isSelf) {%>
                            <br>
                            <form action="/addfriend?wallToVisit=<%=user%>" method="post">
                                <button type="submit" class="btn btn-primary" style="background-color:#99DFFF">Add Friend</button>
                            </form>
                        <% } %>
                        <div class="h7 text-muted">Fullname: <%=wallFullName%></div>  
                        <div class="h7" style="color:#535353">Bio: </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item" style="background-color:#242526">
                            <div class="h6 text-muted" style="color:#E1E1E1">Friends</div>
                            <div class="h5">
                                <div class="friend-list">
                                    <a class="button" href="/friendsof?user=<%=user%>">Friends</a>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item" style="background-color:#242526;border-bottom-left-radius:10px;border-bottom-right-radius:10px">
                            <div class="h6 text-muted" style="color:#E1E1E1">Network</div>
                            <div class="h5">
                                <div class="network-graph">
                                    <a class="button" href="/graphof">Graph Link</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <!--PHILIP REMOVE END-->
            </div>
            <!--MIDDLE BAR-->
            <div class="col-md-6 gedf-main">

            <!--- POST ON FRIEND'S WALL-->
            <%if (isSelf) { %>
                <div class="card gedf-card" style="background-color:#242526;border-radius:10px">
                    <div class="card-header" style="font-size:20px; color:#E1E1E1">
                        Make a Post
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                           <div class="tab-pane fade show active" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                            <form>
                                    <textarea class="form-control" name="content" rows="3" placeholder="What's on your mind, <%=username%>?" class="form-control" style="background-color:#3a3b3c;border-color:#3a3b3c;color:#E1E1E1"required></textarea>
                                    <br>
                                   
                                    <input type="hidden" name="currentWall" value="<%=username%>">
                                    <input type="hidden" name="posterID" value="<%=username%>">
                                    <input type="hidden" name="friend" value="false">
                                    <button type="button" class="btn btn-lg btn-primary btn-block" onclick="makeNewPost()">Post</button>
                            </form>
                               
                           </div>
                        </div>
                        <div class="btn-toolbar justify-content-between">
                      
                            <div class="btn-group">
                                <button id="btnGroupDrop1" type="button" class="btn btn-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                                    aria-expanded="false">
                                    <i class="fa fa-globe"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="btnGroupDrop1">
                                    <a class="dropdown-item" href="#"><i class="fa fa-globe"></i> Public</a>
                                    <a class="dropdown-item" href="#"><i class="fa fa-users"></i> Friends</a>
                                    <a class="dropdown-item" href="#"><i class="fa fa-user"></i> Just me</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } else if (isFriend) {%>
                <div class="card gedf-card" style="background-color:#242526;border-radius:10px">
                    <div class="card-header" style="font-size:20px; color:#E1E1E1">
                        Make a Post on <%=user%>'s Wall
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                           <div class="tab-pane fade show active" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                            <form>
                                    <textarea class="form-control" name="content" rows="3" placeholder="What's on your mind, <%=username%>?" class="form-control" style="background-color:#3a3b3c;border-color:#3a3b3c;color:#E1E1E1"required></textarea>
                                    <br>
                                   
                                    <input type="hidden" name="currentWall" value="<%=username%>">
                                    <input type="hidden" name="posterID" value="<%=username%>">
                                    <input type="hidden" name="friend" value="true">
                                    <button type="button" class="btn btn-lg btn-primary btn-block" onclick="makeNewPost()">Post</button>
                            </form>
                               
                           </div>
                        </div>
                        <div class="btn-toolbar justify-content-between">
                      
                            <div class="btn-group">
                                <button id="btnGroupDrop1" type="button" class="btn btn-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                                    aria-expanded="false">
                                    <i class="fa fa-globe"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="btnGroupDrop1">
                                    <a class="dropdown-item" href="#"><i class="fa fa-globe"></i> Public</a>
                                    <a class="dropdown-item" href="#"><i class="fa fa-users"></i> Friends</a>
                                    <a class="dropdown-item" href="#"><i class="fa fa-user"></i> Just me</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
                <!--render all wall posts-->
                <div id="user-posts">

                </div>

			</div>
        </div>
    </div>
</body>

<script>
    var IDsToPostsMap = new Map();
    var IDsToCommentsMap = new Map();

    //var IDsToCommentsStringMap = new Map();

    var postIDsOnClient = [];

    var postList = [];

    function initPostsandComments() {
        // TODO: DISPLAY POSTS ON THE HOME PAGE
        // iterate through all of the posts
        console.log("initAllPosts called");
        var container = document.getElementById("user-posts");
        var count = 0;

        <% for (let[postID, post] of wallPosts) {%>
            IDsToCommentsMap.set("<%=postID%>", []);
        <% } %>
        
        <% for (var i = 0; i < wallComments.length; i++) { %>
            <% for (let j = 0; j < wallComments[i].length; j++) { %>

                var commentList = IDsToCommentsMap.get("<%=wallComments[i][j].postID%>");

                var stringDiv = "<p style=\"color:#E1E1E1\">username: <%=wallComments[i][j].username%></p>" +
                                "<p style=\"color:#E1E1E1\">commentID: <%=wallComments[i][j].commentID%></p>" +
                                "<p style=\"color:#E1E1E1\">comment: <%=wallComments[i][j].comment%></p>";
                commentList.push(stringDiv);
            <% } %>
        <%}%>

        <%for (let [postID, post] of wallPosts) { %>
            var commentList = IDsToCommentsMap.get("<%=postID%>");

            var content = "<div class=\"card gedf-card\" id=\"<%=postID%>\"style=\"background-color:#242526;border-radius:10px\">" +
                        "<div class=\"card-header\">" +
                            "<div class=\"d-flex justify-content-between align-items-center\">" +
								"<div class=\"d-flex justify-content-between align-items-center\">" +
									"<div class=\"mr-2\">" +
										"<img class=\"rounded-circle\" width=\"45\" src=\"https://tastyethnics.com/wp-content/uploads/bb-plugin/cache/default-profile-square.png\">" +
                                    "</div>";
            <% if(post.friend) { %>
                //DO NOTHING ABOUT THE HEADER
            <%} else { %>
                <% if (post.posterID) { %>
                    //someone posted on someone else's wall
                    content += "<div class=\"ml-2\">" +
                                "<div class=\"h5 m-0\" style=\"color:#E1E1E1\"><%=post.posterName%> posted on <%=post.userName%>'s wall </div>" +
							"</div>";
                <% } else { %>
                    //anything involving just you, i.e changing interest, posted on your own wall, etc.
                    content += "<div class=\"ml-2\">" +
                                "<div class=\"h5 m-0\" style=\"color:#E1E1E1\"><%=post.userName%> </div>" +
							"</div>";
                <% } %>
            <% } %>
            content +=      "</div>" +
                        "</div>" +
                    "</div>" +
                    "<div class=\"card-body\">" +
                        "<div class=\"text-muted h7 mb-2\"> <i class=\"fa fa-clock-o\"></i><%=post.timestamp%></div>" +
                        "<a class=\"card-link\" href=\"#\">" +
                            "<h5 class=\"card-title\"><%=post.postID%></h5>" +
                        "</a>" +
                        "<p class=\"card-text\" style=\"color:#E1E1E1\"> <%=post.content%></p>" +
                        "</div>";
           
            content += "<div class=\"card-footer\">" + 
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-gittip\" style=\"color:red\"></i> Like</a>" +
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-comment\" style=\"color:yellow\"></i> Comment</a>" + 
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-mail-forward\" style=\"color:green\"></i> Share</a>" +
                    "</div>" +
                    "<div class=\"card-body\">" +
                        "<div class=\"card-subtitle\">" +
                            "Comments" +
                            "<div id=\"comments<%=post.postID%>\">" +
                                
                            "</div>" +
                        "</div>" +
                        "<div class=\"comment-list\">";

            for (var i = 0; i < commentList.length; i++) {
                content += commentList[i];
            }    
            
            content += "</div>" +
                        "<form>" +
                            "<div class=\"form-group\">" +
                                "<label class=\"sr-only\" for=\"message\">post</label>" +
                                "<textarea class=\"form-control\" style=\"height:70px;background-color:#3a3b3c;border-color:#3a3b3c;color:#E1E1E1\" name=\"commentContent<%=post.postID%>\" rows=\"3\" placeholder=\"Leave a comment, <%=username%>!\" required></textarea>" +
                                "<br>" +
                              
                                "<button type=\"button\" id=\"b_<%=post.postID%>\" value=\"Comment\" class=\"btn btn-lg btn-primary\" onclick=\"makeNewComment(this.id)\">Comment</button>" +
                            " </div>" +
                        "</form>" +
                    " </div>" +
                "</div> ";
            postIDsOnClient.push("<%=post.postID%>");
            postList.push("<%=post%>");
            IDsToPostsMap.set("<%=post.postID%>", content);
            container.innerHTML += content;
        <% } %>
    }

    // TODO: ejs form submit button (for making a new post) should have: onclick="makeNewPost()"
    // makes a new post when the user submits the form for creating a post
    function makeNewPost() {
    	//alert("You made a new post. TODO (Di): Display the new post on the home page.");
        // get the user's inputted fields
        var postContent = $('textarea[name="content"]').val();
        //console.log("post Content:" + postContent);

        $.ajax({
            url: "/postonwall",
            type: "POST",
            data:
                {   
                    content: postContent
                },
            success: function(data) {
                alert(data.postID);
                var container = document.getElementById("user-posts");

                var content = "<div class=\"card gedf-card\" id=\"" + data.postID + "\"style=\"background-color:#242526;border-radius:10px\">" +
                "<div class=\"card-header\">" +
                    "<div class=\"d-flex justify-content-between align-items-center\">" +
                        "<div class=\"d-flex justify-content-between align-items-center\">" +
                            "<div class=\"mr-2\">" +
                                "<img class=\"rounded-circle\" width=\"45\" src=\"https://tastyethnics.com/wp-content/uploads/bb-plugin/cache/default-profile-square.png\">" +
                            "</div>";
                content += "<div class=\"ml-2\">" +
                                "<div class=\"h5 m-0\" style=\"color:#E1E1E1\">" + data.userName+ "</div>" +
                            "</div>";
                content +=      "</div>" +
                            "</div>" +
                        "</div>" +
                        "<div class=\"card-body\">" +
                            "<div class=\"text-muted h7 mb-2\"> <i class=\"fa fa-clock-o\"></i>" + data.timestamp + "</div>" +
                            "<a class=\"card-link\" href=\"#\">" +
                                "<h5 class=\"card-title\">" + data.postID + "</h5>" +
                            "</a>" +
                            "<p class=\"card-text\" style=\"color:#E1E1E1\">" + data.content + "</p>" +
                        "</div>";
                
                        
                content +=   "<div class=\"card-footer\">" + 
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-gittip\" style=\"color:red\"></i> Like</a>" +
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-comment\" style=\"color:yellow\"></i> Comment</a>" + 
                            "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-mail-forward\" style=\"color:green\"></i> Share</a>" +
                        "</div>" +
                        "<div class=\"card-body\">" +
                            "<div class=\"card-subtitle\" style=\"color:#E1E1E1\">" +
                                "Comments" +
                                "<div id=\"comments" + data.postID + "\">" +

                                "</div>" +
                            "</div>" +
                            "<form>" +
                                "<div class=\"form-group\">" +
                                    "<label class=\"sr-only\" for=\"message\">post</label>" +
                                    "<textarea class=\"form-control\" style=\"height:70px;background-color:#3a3b3c;border-color:#3a3b3c;color:#E1E1E1\" name=\"commentContent" + data.postID + "\" rows=\"3\" placeholder=\"Leave a comment, <%=username%>!\" required></textarea>" +
                                    "<br>" +
                                    
                                    "<button type=\"button\" id=\"b_" + data.postID + "\"value=\"Comment\" class=\"btn btn-lg btn-primary\" onclick=\"makeNewComment(this.id)\">" +
                                " </div>" +
                            "</form>" +
                        " </div>" +
                    "</div> ";
                postIDsOnClient.push(data.postID);
                IDsToPostsMap.set(data.postID, data);
                IDsToCommentsMap.set(data.postID, []);

                //ADDS THE NEWEST POST AT THE BEGINNING OF ALL P OSTS.
                container.innerHTML = (content + container.innerHTML);
            }
        })
    }

    function makeNewComment(buttonID) {
        var postID = buttonID.substring(2, buttonID.length);
        var comment = $('textarea[name="commentContent' + postID +'"]').val();

        $.ajax({
            url: "/commentonpost",
            type: "POST",
            data:
                {   
                    commentContent: comment,
                    postID: postID
                },
            success: function(data) {
                var commentsList = IDsToCommentsMap.get(data.postID);
                var divString = "<p style=\"color:#E1E1E1\">username: " + data.username + "</p>" +
                                "<p style=\"color:#E1E1E1\">commentID: " + data.commentID + "</p>" +
                                "<p style=\"color:#E1E1E1\">comment: " + data.comment + "</p>";
                commentsList.push(divString);

                var container = document.getElementById("comments" + data.postID);
                container.innerHTML = divString + container.innerHTML;
            }

        });
    }
    // automatic refresh every 5 seconds to update home page
    var refreshTime = function() {
        // set clock to refresh every 5000 ms
        $("#clock").html((new Date()).toString());
        setTimeout(refreshTime, 5000);
        // make AJAX call to get the home page posts and compare the data from the server to the data on the client
        $.ajax({
                url: "/wall",
                type: "GET",
                success: function(data) {
                    // lists containing the differences between the server and client
                    var newPosts = [];
                    var newComments = [];
                    
                    if (data) {
                    	if (data.wallPosts) {
		                    // iterate through data (posts) sent from server
		                    data.wallPosts.forEach(p => {
                                if (!postIDsOnClient.includes(p.postID)) {
                                    postsIDsOnClient.push(p.postID);
                                }
		                    });
	                    }
	                    if (data.comments) {
		                    // iterate through data (comments) sent from server
		                    data.wallComments.forEach(c => {
		                    	console.log("New comment added, see below");
		                    	console.log(JSON.stringify(c));
		                    	
		                    	// AAAAAAAAAAAAAAAAAHHHHHHHHHHHHHHHHHHHHHHHHHHHH
		                        // put the post in the list if it's from the server but not on the client
		                        if (!commentsOnPosts.includes(c)) {
		                            newComments.push(c);
		                            // update the client-side list to contain new posts from the server
		                            commentsOnPosts.push(c);
		                        }
		                    });
                        }
                    }
                    
                    //console.log("440:");
                    //console.log(newPosts);
                        
                    // TODO: ACTUALLY DISPLAY THE NEW POSTS THAT THE SERVER HAS SENT TO THE CLIENT

                    var container = document.getElementById("user-posts");
                    newPosts.forEach(newPost => {
                        //VISUAL RENDER OF THE NEWPOST
                        console.log("make new post");
                        var content = "<div class=\"card gedf-card\" id=\"" + newPost.postID + "\"style=\"background-color:#242526;border-radius:10px\">" +
                        "<div class=\"card-header\">" +
                            "<div class=\"d-flex justify-content-between align-items-center\">" +
								"<div class=\"d-flex justify-content-between align-items-center\">" +
									"<div class=\"mr-2\">" +
										"<img class=\"rounded-circle\" width=\"45\" src=\"https://icon-library.com/images/default-profile-icon/default-profile-icon-17.jpg\">" +
                                    "</div>";
                        if(newPost.friend) {
                            //DO NOTHING ABOUT THE HEADER
                        } else {
                            if (newPost.posterID) {
                                //someone posted on someone else's wall
                                content += "<div class=\"ml-2\">" +
                                            "<div class=\"h5 m-0\" style=\"color:#E1E1E1\">" + newPost.posterName + " posted on " + newPost.userName + "'s wall </div>" +
                                        "</div>";
                            } else {
                                //anything involving just you, i.e changing interest, posted on your own wall, etc.
                                content += "<div class=\"ml-2\">" +
                                            "<div class=\"h5 m-0\" style=\"color:#E1E1E1\">" + newPost.userName + "</div>" +
                                        "</div>";
                            }
                        }
                        content +=      "</div>" +
                                    "</div>" +
                                "</div>" +
                                "<div class=\"card-body\">" +
                                    "<div class=\"text-muted h7 mb-2\"> <i class=\"fa fa-clock-o\"></i>" + newPost.timestamp + "</div>" +
                                    "<a class=\"card-link\" href=\"#\">" +
                                        "<h5 class=\"card-title\">" + newPost.postID + "</h5>" +
                                    "</a>" +
                                    "<p class=\"card-text\" style=\"color:#E1E1E1\">" + newPost.content + "</p>" +
                                "</div>";
                        
                        content +=        "<div class=\"card-footer\">" + 
                                    "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-gittip\" style=\"color:red\"></i> Like</a>" +
                                    "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-comment\" style=\"color:yellow\"></i> Comment</a>" + 
                                    "<a href=\"#\" class=\"card-link\"><i class=\"fa fa-mail-forward\" style=\"color:green\"></i> Share</a>" +
                                "</div>" +
                                "<div class=\"card-body\">" +
                                    "<div class=\"card-subtitle\" style=\"color:#E1E1E1\">" +
                                        "Comments" +
                                    "</div>" +
                                    "<div id=\"comments" + newPost.postID + "\">" +

                                    "</div>" +
                                    "<form>" +
                                        "<div class=\"form-group\">" +
                                            "<label class=\"sr-only\" for=\"message\">post</label>" +
                                            "<textarea class=\"form-control\" style=\"height:70px;background-color:#3a3b3c;border-color:#3a3b3c;color:#E1E1E1\" name=\"commentContent" + newPost.postID + "\" rows=\"3\" placeholder=\"Leave a comment, <%=username%>!\" required></textarea>" +
                                            "<br>" +
                                            
                                            "<button type=\"button\" id=\"b_" + newPost.postID + "\"value=\"Comment\" class=\"btn btn-lg btn-primary\" onclick=\"makeNewComment(this.id)\">" +
                                        " </div>" +
                                    "</form>" +
                                " </div>" +
                            "</div> ";
                        postIDsonClient.push(newPost.postID);
                        postsList.push(newPost);

                        // ADDS THE NEWEST POST AT THE BEGINNING OF ALL POSTS
                        container.innerHTML = content + container.innerHTML;
                    });
                }
            })
    };

    initPostsandComments();

    //renderPostsAndComments();

    $(document).ready(function() {
        $("#clock").css("color", "white");
        setTimeout(refreshTime, 5000);
    });

    $(document).ready(function() {
        $("#nameToSearch").keyup(function() {
            var targetName = $(this).val();
            //console.log("target name: " + targetName);
            if (targetName != "") {
                $.ajax({
                    url: '/usersearch',
                    type: 'GET',
                    data: {
                        nameToSearch: targetName
                    },
                    success: function(data) {
                        //alert("HERE'S AN ALERT. DATA IS");
                        //alert(data);
                        var len = data.length;
                        //console.log(data);
                        $("#searchResult").empty();
                        var smallerLen = Math.min(len, 5);
                        for (var i = 0; i < smallerLen; i++) {
                            $("#searchResult").append("<li><a href=\"/wall?wallToVisit=" + data[i].username + "\">" + 
                                data[i].fullname + "</a></li>");
                        }
                    }

                });
            }
        });
    });
</script>